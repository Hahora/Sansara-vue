<template>
  <div class="p-4">
    <div class="flex items-center mb-4">
      <router-link to="/" class="btn-back mr-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        –ù–∞–∑–∞–¥
      </router-link>
      <h1 class="page-title text-xl">–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h1>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="isLoading" class="flex justify-center items-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#4e5d51]"></div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div v-else-if="error" class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700 mb-4">
      {{ error }}
    </div>

    <div v-else class="space-y-4">
      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö -->
      <div class="card">
        <h2 class="section-title">‚ú® <b>–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</b></h2>
        <p class="text-black text-sm mb-3">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏, –≥–ª—É–±–æ–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —Ä–∞–±–æ—Ç–∞ —Å —Ç–µ–ª–æ–º –∏ —ç–Ω–µ—Ä–≥–∏–µ–π</p>

        <div class="bg-wood-50 rounded-lg p-3 mb-3">
          <p class="text-black"><b>–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:</b></p>
          <p class="text-black">–≠—Ç–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∏–ª–∏ –ø–∞—Ä–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å –º–∞—Å—Ç–µ—Ä–æ–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ö–∞–∂–¥–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –∞–≤—Ç–æ—Ä—Å–∫–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—à–∏—Ö –º–∞—Å—Ç–µ—Ä–æ–≤.</p>

          <p class="text-black mt-2"><b>–ü—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥–±–∏—Ä–∞—é—Ç—Å—è –ø–æ–¥ –≤–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∑–∞–ø—Ä–æ—Å.</b></p>
        </div>
      </div>

      <!-- –ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ -->
      <div class="card">
        <h2 class="section-title">–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ</h2>

        <div class="space-y-2">
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–ü–æ–ª–Ω–æ–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ç–µ–ª–∞</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –∏ —Å—Ç—Ä–µ—Å—Å–∞</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–ü–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–û—â—É—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–†–∞–±–æ—Ç–∞ —Å –¥—ã—Ö–∞–Ω–∏–µ–º –∏ —Ç–µ–ª–æ–º</span>
          </div>
        </div>
      </div>

      <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º -->
      <div class="card">
        <h2 class="section-title">–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º</h2>

        <div class="grid grid-cols-2 gap-2">
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">ü§≤ –ü–∞—Ä–µ–Ω–∏–µ –≤ —á–µ—Ç—ã—Ä–µ —Ä—É–∫–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üé≠ –ë–∞–Ω–Ω—ã–µ —Ü–µ—Ä–µ–º–æ–Ω–∏–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üåø –§–∏—Ç–æ-–ø–∞—É–∑—ã —Å —Ç—Ä–∞–≤–∞–º–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üîî –ó–≤—É–∫–æ–≤–∞—è —Ç–µ—Ä–∞–ø–∏—è</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üå∏ –ê—Ä–æ–º–∞–ø—Ä–∞–∫—Ç–∏–∫–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üíß –ö—É–ø–µ–ª—å –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—ã</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">‚ô®Ô∏è –ì–ª—É–±–æ–∫–∏–π –¥–æ–≥—Ä–µ–≤</p>
          </div>
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º -->
      <div v-if="authorPrograms.length > 0" class="card">
        <h2 class="section-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2>

        <div class="space-y-3">
          <div
            v-for="program in authorPrograms"
            :key="program.id"
            class="bg-wood-50 rounded-lg p-3 border border-wood-200 cursor-pointer hover:bg-wood-100 transition-colors"
            @click="openProgramDetails(program)"
          >
            <div class="flex justify-between items-start">
              <div>
                <p class="text-black font-medium">{{ program.name }}</p>
                <p class="text-black text-sm">{{ truncateText(program.description, 80) }}</p>
              </div>
              <span class="text-black font-medium whitespace-nowrap">{{ program.price ? program.price / 100 : '–ü–æ –∑–∞–ø—Ä–æ—Å—É' }} ‚ÇΩ</span>
            </div>
          </div>
        </div>
      </div>

      <!-- –°—Å—ã–ª–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div class="space-y-3">
        <!-- –ò—â–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º -->
        <div v-if="authorProgram">
          <router-link
            :to="{
              name: 'BookingWithParams',
              params: {
                programId: authorProgram.id,
                programType: authorProgram.program_type,
                eventId: authorProgram.slug
              }
            }"
            class="btn-primary block text-center text-black font-semibold"
          >
            üéØ –ü–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ–¥ –º–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          </router-link>
        </div>
        <div v-else>
          <router-link
            :to="{ name: 'BookingWithParams', params: { programType: 'author' }}"
            class="btn-primary block text-center text-black font-semibold opacity-70 cursor-not-allowed"
            disabled
          >
            üéØ –ü–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ–¥ –º–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          </router-link>
          <p class="text-red-500 text-xs mt-1 text-center">
            –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
          </p>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
    <ProgramDetailsModal
      :is-open="showProgramDetails"
      :program="selectedProgram"
      @close="closeProgramDetails"
    />
  </div>
</template>

<script>
import { mapState, mapGetters, mapActions } from 'pinia';
import { useAppStore } from '@/stores/appStore';
import ProgramDetailsModal from '@/components/ProgramDetailsModal.vue';

export default {
  name: 'AuthorProgramsPage',
  components: {
    ProgramDetailsModal
  },
  data() {
    return {
      showProgramDetails: false,
      selectedProgram: {}
    };
  },
  computed: {
    ...mapState(useAppStore, ['isLoading', 'error', 'programs', 'user', 'programsLoaded']),
    ...mapGetters(useAppStore, ['getProgramsByType']),

    authorPrograms() {
      return this.getProgramsByType('author') || []; // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º lowercase, —Ç.–∫. —Å—Ç–æ—Ä –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç enum-–∑–Ω–∞—á–µ–Ω–∏—è
    },

    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º
    authorProgram() {
      if (!this.programs || this.programs.length === 0) return null;

      // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É —Å —Ç–∏–ø–æ–º 'author'
      let program = this.programs.find(p =>
        p.program_type === 'author'
      );

      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
      if (!program) {
        program = this.programs.find(p =>
          p.name.toLowerCase().includes('–∞–≤—Ç–æ—Ä') ||
          p.name.toLowerCase().includes('–º–∞—Å—Ç–µ—Ä') ||
          p.name.toLowerCase().includes('–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω') ||
          p.name.toLowerCase().includes('author') ||
          p.name.toLowerCase().includes('master')
        );
      }

      return program || null;
    }
  },
  async mounted() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (!this.programsLoaded && this.loadPrograms) {
      await this.loadPrograms();
    }
  },
  methods: {
    ...mapActions(useAppStore, ['loadPrograms']),

    truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    },

    openProgramDetails(program) {
      this.selectedProgram = program;
      this.showProgramDetails = true;
    },

    closeProgramDetails() {
      this.showProgramDetails = false;
      this.selectedProgram = {};
    }
  }
}
</script>