<template>
  <div class="p-4">
    <div class="flex items-center mb-4">
      <router-link to="/" class="btn-back mr-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        –ù–∞–∑–∞–¥
      </router-link>
      <h1 class="page-title text-xl">–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</h1>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="isLoading" class="flex justify-center items-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#4e5d51]"></div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div v-else-if="error" class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700 mb-4">
      {{ error }}
    </div>

    <div v-else class="space-y-4">
      <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
      <div class="card">
        <h2 class="section-title">üéÅ <b>–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</b></h2>
        <p class="text-black text-sm mb-3">–ü–æ–¥–∞—Ä–∏—Ç–µ –∑–∞–±–æ—Ç—É, —Å—á–∞—Å—Ç—å–µ –∏ —Ä–µ—Å—É—Ä—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</p>

        <div class="bg-gray-50 rounded-lg p-3 mb-3">
          <p class="text-black"><b>–í–∏–¥—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:</b></p>
        </div>

        <div class="space-y-3">
          <div class="bg-gray-50 rounded-lg p-3">
            <p class="text-black font-medium">üìã –ù–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É</p>
            <p class="text-black text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É ‚Äî –ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø—Ä–∏–¥—ë—Ç –Ω–∞ –Ω–µ—ë</p>
          </div>

          <div class="bg-gray-50 rounded-lg p-3">
            <p class="text-black font-medium">üí∞ –ù–∞ –¥–µ–ø–æ–∑–∏—Ç (–Ω–æ–º–∏–Ω–∞–ª)</p>
            <p class="text-black text-sm">–ü–æ–ª—É—á–∞—Ç–µ–ª—å —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É</p>
          </div>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ -->
      <div class="card">
        <div class="space-y-3">
          <button @click="openCertificateModal('program')" class="w-full bg-wood-50 text-black font-medium py-3 px-4 rounded-lg border border-wood-300 transition-colors duration-200 text-left">
            üìã –ù–∞ –ø—Ä–æ–≥—Ä–∞–º–º—É
          </button>

          <button @click="openCertificateModal('deposit')" class="w-full bg-wood-50 text-black font-medium py-3 px-4 rounded-lg border border-wood-300 transition-colors duration-200 text-left">
            üí∞ –ù–∞ –¥–µ–ø–æ–∑–∏—Ç
          </button>
        </div>
      </div>

      <!-- –ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ -->
      <div class="card">
        <h2 class="section-title">–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ</h2>

        <div class="space-y-2">
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–ü–æ–ª–Ω–æ–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ç–µ–ª–∞</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –∏ —Å—Ç—Ä–µ—Å—Å–∞</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–ü–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–û—â—É—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</span>
          </div>
          <div class="flex items-start">
            <span class="text-green-700 text-2xl mr-2">‚úì</span>
            <span class="text-black">–†–∞–±–æ—Ç–∞ —Å –¥—ã—Ö–∞–Ω–∏–µ–º –∏ —Ç–µ–ª–æ–º</span>
          </div>
        </div>
      </div>

      <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º -->
      <div class="card">
        <h2 class="section-title">–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º</h2>

        <div class="grid grid-cols-2 gap-2">
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">ü§≤ –ü–∞—Ä–µ–Ω–∏–µ –≤ —á–µ—Ç—ã—Ä–µ —Ä—É–∫–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üé≠ –ë–∞–Ω–Ω—ã–µ —Ü–µ—Ä–µ–º–æ–Ω–∏–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üåø –§–∏—Ç–æ-–ø–∞—É–∑—ã —Å —Ç—Ä–∞–≤–∞–º–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üîî –ó–≤—É–∫–æ–≤–∞—è —Ç–µ—Ä–∞–ø–∏—è</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üå∏ –ê—Ä–æ–º–∞–ø—Ä–∞–∫—Ç–∏–∫–∏</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">üíß –ö—É–ø–µ–ª—å –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—ã</p>
          </div>
          <div class="bg-wood-50 rounded-lg p-2 text-center">
            <p class="text-black text-sm">‚ô®Ô∏è –ì–ª—É–±–æ–∫–∏–π –¥–æ–≥—Ä–µ–≤</p>
          </div>
        </div>
      </div>


      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div class="space-y-3">
        <router-link to="/programs" class="btn-secondary block text-center">
          üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã
        </router-link>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ -->
    <div v-if="showCertificateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-black">üéÅ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</h3>
            <button @click="closeModal" class="text-black hover:text-gray-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <!-- –®–∞–≥ 1: –¢–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω –∑–∞—Ä–∞–Ω–µ–µ) -->
          <div v-if="currentStep === 1 && !selectedCertType">
            <h4 class="font-medium text-black mb-3">üõí –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:</h4>

            <div class="space-y-3">
              <button
                @click="selectedCertType = 'program'; nextStep()"
                class="w-full bg-wood-50 text-black font-medium py-3 px-4 rounded-lg border border-wood-300 transition-colors duration-200 text-left"
              >
                üìã –ù–∞ –ø—Ä–æ–≥—Ä–∞–º–º—É
              </button>

              <button
                @click="selectedCertType = 'deposit'; nextStep()"
                class="w-full bg-wood-50 text-black font-medium py-3 px-4 rounded-lg border border-wood-300 transition-colors duration-200 text-left"
              >
                üí∞ –ù–∞ –¥–µ–ø–æ–∑–∏—Ç
              </button>
            </div>
          </div>

          <!-- –ï—Å–ª–∏ —Ç–∏–ø —É–∂–µ –≤—ã–±—Ä–∞–Ω, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–ª–∏ —Å—É–º–º—ã -->
          <div v-if="currentStep === 1 && selectedCertType && !selectedProgram && !selectedAmount">
            <h4 class="font-medium text-black mb-3" v-if="selectedCertType === 'program'">üìã –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É:</h4>
            <h4 class="font-medium text-black mb-3" v-else>üí∞ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–∏–Ω–∞–ª:</h4>

            <div v-if="selectedCertType === 'program'" class="space-y-3 max-h-60 overflow-y-auto">
              <div
                v-for="program in certificatePrograms"
                :key="program.id"
                @click="selectProgram(program)"
                :class="{'bg-wood-200': selectedProgram && selectedProgram.id === program.id}"
                class="bg-gray-50 rounded-lg p-3 border border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-black font-medium">{{ program.name }}</p>
                    <p class="text-black text-sm">{{ truncateText(program.description, 80) }}</p>
                  </div>
                  <span class="text-black font-medium">{{ program.price ? program.price / 100 : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É' }} ‚ÇΩ</span>
                </div>
              </div>
            </div>

            <div v-else class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <button
                  v-for="amount in depositAmounts"
                  :key="amount.value"
                  @click="selectAmount(amount)"
                  :class="{'bg-wood-200': selectedAmount && selectedAmount.value === amount.value}"
                  class="bg-gray-50 text-black font-medium py-3 px-4 rounded-lg border border-gray-300 transition-colors duration-200"
                >
                  {{ amount.label }}
                </button>
              </div>

              <div class="mt-3">
                <label class="block text-sm font-medium text-black mb-1">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Å—É–º–º—É:</label>
                <input
                  v-model="customAmount"
                  type="number"
                  min="1000"
                  class="form-input w-full"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö"
                />
                <button
                  v-if="customAmount && parseInt(customAmount) >= 1000"
                  @click="selectCustomAmount"
                  class="mt-2 btn-primary block text-center w-full"
                >
                  –í—ã–±—Ä–∞—Ç—å {{ customAmount }} ‚ÇΩ
                </button>
              </div>
            </div>

            <div class="mt-6 flex justify-between">
              <button @click="prevStep" class="btn-secondary py-2 px-6 rounded-lg">
                –ù–∞–∑–∞–¥
              </button>
              <button
                @click="nextStep"
                :disabled="!(selectedProgram || selectedAmount)"
                :class="{'opacity-50 cursor-not-allowed': !(selectedProgram || selectedAmount)}"
                class="btn-primary py-2 px-6 rounded-lg"
              >
                –î–∞–ª–µ–µ
              </button>
            </div>
          </div>

          <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–ª–∏ —Å—É–º–º—ã (–¥–ª—è –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ —Ç–∏–ø —É–∂–µ –≤—ã–±—Ä–∞–Ω, –Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞/—Å—É–º–º–∞ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã) -->
          <div v-if="currentStep === 2 && selectedCertType && !selectedProgram && !selectedAmount">
            <h4 class="font-medium text-black mb-3" v-if="selectedCertType === 'program'">üìã –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É:</h4>
            <h4 class="font-medium text-black mb-3" v-else>üí∞ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–∏–Ω–∞–ª:</h4>

            <div v-if="selectedCertType === 'program'" class="space-y-3 max-h-60 overflow-y-auto">
              <div
                v-for="program in certificatePrograms"
                :key="program.id"
                @click="selectProgram(program)"
                :class="{'bg-wood-200': selectedProgram && selectedProgram.id === program.id}"
                class="bg-gray-50 rounded-lg p-3 border border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-black font-medium">{{ program.name }}</p>
                    <p class="text-black text-sm">{{ truncateText(program.description, 80) }}</p>
                  </div>
                  <span class="text-black font-medium">{{ program.price ? program.price / 100 : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É' }} ‚ÇΩ</span>
                </div>
              </div>
            </div>

            <div v-else class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <button
                  v-for="amount in depositAmounts"
                  :key="amount.value"
                  @click="selectAmount(amount)"
                  :class="{'bg-wood-200': selectedAmount && selectedAmount.value === amount.value}"
                  class="bg-gray-50 text-black font-medium py-3 px-4 rounded-lg border border-gray-300 transition-colors duration-200"
                >
                  {{ amount.label }}
                </button>
              </div>

              <div class="mt-3">
                <label class="block text-sm font-medium text-black mb-1">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Å—É–º–º—É:</label>
                <input
                  v-model="customAmount"
                  type="number"
                  min="1000"
                  class="form-input w-full"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö"
                />
                <button
                  v-if="customAmount && parseInt(customAmount) >= 1000"
                  @click="selectCustomAmount"
                  class="mt-2 btn-primary block text-center w-full"
                >
                  –í—ã–±—Ä–∞—Ç—å {{ customAmount }} ‚ÇΩ
                </button>
              </div>
            </div>

            <div class="mt-6 flex justify-between">
              <button @click="prevStep" class="btn-secondary py-2 px-6 rounded-lg">
                –ù–∞–∑–∞–¥
              </button>
              <button
                @click="nextStep"
                :disabled="!(selectedProgram || selectedAmount)"
                :class="{'opacity-50 cursor-not-allowed': !(selectedProgram || selectedAmount)}"
                class="btn-primary py-2 px-6 rounded-lg"
              >
                –î–∞–ª–µ–µ
              </button>
            </div>
          </div>

          <!-- –®–∞–≥ 2 (–ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∏–ø–µ) –∏–ª–∏ —à–∞–≥ 3 (–ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏): –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ -->
          <div v-if="(currentStep === 2 && selectedCertType && (selectedProgram || selectedAmount)) || (currentStep === 3 && !selectedCertType && (selectedProgram || selectedAmount))">
            <h4 class="font-medium text-black mb-3">üìÑ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:</h4>
            
            <div class="space-y-3">
              <button 
                @click="selectedFormat = 'electronic'; nextStep()" 
                class="w-full bg-wood-50 text-black font-medium py-3 px-4 rounded-lg border border-wood-300 transition-colors duration-200 text-left"
              >
                üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π ‚Äî –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ email
              </button>

              <button 
                @click="selectedFormat = 'printed'; nextStep()" 
                class="w-full bg-wood-50 text-black font-medium py-3 px-4 rounded-lg border border-wood-300 transition-colors duration-200 text-left"
              >
                üìÑ –ü–µ—á–∞—Ç–Ω—ã–π ‚Äî –∫—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ (+500 ‚ÇΩ)
              </button>
            </div>

            <div class="mt-6 flex justify-between">
              <button @click="prevStep" class="btn-secondary py-2 px-6 rounded-lg">
                –ù–∞–∑–∞–¥
              </button>
              <button
                @click="nextStep"
                :disabled="!selectedFormat"
                :class="{'opacity-50 cursor-not-allowed': !selectedFormat}"
                class="btn-primary py-2 px-6 rounded-lg"
              >
                –î–∞–ª–µ–µ
              </button>
            </div>
          </div>

          <!-- –®–∞–≥ 4 (–ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏) –∏–ª–∏ —à–∞–≥ 3 (–ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∏–ø–µ): –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è -->
          <div v-if="(currentStep === 4 && !selectedCertType && (selectedProgram || selectedAmount)) || (currentStep === 3 && selectedCertType && (selectedProgram || selectedAmount))">
            <h4 class="font-medium text-black mb-3">Recipient Information</h4>
            
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-black mb-1">–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <input
                  v-model="recipientName"
                  type="text"
                  class="form-input w-full"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-1">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <input
                  v-model="recipientPhone"
                  type="tel"
                  class="form-input w-full"
                  placeholder="+7 (XXX) XXX-XX-XX"
                />
              </div>
            </div>

            <div class="mt-6 flex justify-between">
              <button @click="prevStep" class="btn-secondary py-2 px-6 rounded-lg">
                –ù–∞–∑–∞–¥
              </button>
              <button
                @click="nextStep"
                :disabled="!recipientName || !recipientPhone"
                :class="{'opacity-50 cursor-not-allowed': !recipientName || !recipientPhone}"
                class="btn-primary py-2 px-6 rounded-lg"
              >
                –î–∞–ª–µ–µ
              </button>
            </div>
          </div>

          <!-- –®–∞–≥ 5 (–ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏) –∏–ª–∏ —à–∞–≥ 4 (–ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∏–ø–µ): –î–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è -->
          <div v-if="(currentStep === 5 && !selectedCertType && (selectedProgram || selectedAmount)) || (currentStep === 4 && selectedCertType && (selectedProgram || selectedAmount))">
            <h4 class="font-medium text-black mb-3">Buyer Information</h4>

            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-black mb-1">–í–∞—à–µ –∏–º—è:</label>
                <input
                  v-model="buyerName"
                  type="text"
                  class="form-input w-full"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-1">–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω:</label>
                <input
                  v-model="buyerPhone"
                  type="tel"
                  class="form-input w-full"
                  placeholder="+7 (XXX) XXX-XX-XX"
                />
              </div>
            </div>

            <div class="mt-6 flex justify-between">
              <button @click="prevStep" class="btn-secondary py-2 px-6 rounded-lg">
                –ù–∞–∑–∞–¥
              </button>
              <button
                @click="nextStep"
                :disabled="!buyerName || !buyerPhone"
                :class="{'opacity-50 cursor-not-allowed': !buyerName || !buyerPhone}"
                class="btn-primary py-2 px-6 rounded-lg"
              >
                –î–∞–ª–µ–µ
              </button>
            </div>
          </div>

          <!-- –®–∞–≥ 6 (–ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏) –∏–ª–∏ —à–∞–≥ 5 (–ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∏–ø–µ): –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ -->
          <div v-if="(currentStep === 6 && !selectedCertType && (selectedProgram || selectedAmount)) || (currentStep === 5 && selectedCertType && (selectedProgram || selectedAmount))">
            <h4 class="font-medium text-black mb-3">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h4>

            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
              <p><b>–¢–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:</b> {{ selectedCertType === 'program' ? '–ù–∞ –ø—Ä–æ–≥—Ä–∞–º–º—É' : '–ù–∞ –¥–µ–ø–æ–∑–∏—Ç' }}</p>
              <p v-if="selectedProgram"><b>–ü—Ä–æ–≥—Ä–∞–º–º–∞:</b> {{ selectedProgram.name }}</p>
              <p v-if="selectedAmount"><b>–°—É–º–º–∞:</b> {{ selectedAmount.label }}</p>
              <p><b>–§–æ—Ä–º–∞—Ç:</b> {{ selectedFormat === 'electronic' ? '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π' : '–ü–µ—á–∞—Ç–Ω—ã–π' }}</p>
              <p><b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> {{ recipientName }}</p>
              <p><b>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</b> {{ recipientPhone }}</p>
              <p><b>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</b> {{ buyerName }}</p>
              <p><b>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:</b> {{ buyerPhone }}</p>
            </div>

            <div class="mt-6 flex justify-between">
              <button @click="prevStep" class="btn-secondary py-2 px-6 rounded-lg">
                –ù–∞–∑–∞–¥
              </button>
              <button @click="finishOrder" class="btn-primary py-2 px-6 rounded-lg">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
  <div v-if="showConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <div class="text-center">
        <div class="text-4xl mb-4">‚úÖ</div>
        <h3 class="text-xl font-bold text-black mb-2">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h3>
        <p class="text-black mb-4">–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã.</p>

        <div class="bg-gray-100 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-600">–ö–æ–¥ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:</p>
          <p class="text-lg font-mono font-bold text-black">{{ certificateCode }}</p>
        </div>

        <button @click="closeConfirmationModal" class="btn-primary block w-full text-center">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>
</template>

<script>
import { mapState, mapActions } from 'pinia';
import { useAppStore } from '@/stores/appStore';

export default {
  name: 'CertificatesPage',
  data() {
    return {
      showCertificateModal: false,
      showConfirmationModal: false,
      certificateCode: null,
      currentStep: 1,
      selectedCertType: null,
      selectedProgram: null,
      selectedAmount: null,
      customAmount: '',
      selectedFormat: null,
      recipientName: '',
      recipientPhone: '',
      buyerName: '',
      buyerPhone: '',
      depositAmounts: [
        { value: 5000, label: '5 000 ‚ÇΩ' },
        { value: 7000, label: '7 000 ‚ÇΩ' },
        { value: 10000, label: '10 000 ‚ÇΩ' },
        { value: 15000, label: '15 000 ‚ÇΩ' },
        { value: 20000, label: '20 000 ‚ÇΩ' },
      ]
    };
  },
  computed: {
    ...mapState(useAppStore, ['isLoading', 'error', 'programs', 'user', 'certificates']),

    certificatePrograms() {
      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
      return this.programs.filter(program =>
        program.program_type !== 'certificate' &&
        program.is_active !== false
      );
    }
  },
  methods: {
    ...mapActions(useAppStore, ['createCertificate']),

    openCertificateModal(certType) {
      this.showCertificateModal = true;
      this.resetForm();
      this.selectedCertType = certType;
      this.currentStep = 1; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥, –Ω–æ —Å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Ç–∏–ø–æ–º

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
      if (this.user) {
        this.buyerName = this.user.first_name || this.user.username || '';
        this.buyerPhone = this.user.phone || '';
      }
    },

    closeModal() {
      this.showCertificateModal = false;
      this.resetForm();
    },

    closeConfirmationModal() {
      this.showConfirmationModal = false;
      this.certificateCode = null;
    },

    nextStep() {
      if (this.selectedCertType) {
        // –ï—Å–ª–∏ —Ç–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω, –º–∞–∫—Å–∏–º—É–º 5 —à–∞–≥–æ–≤ (–±–µ–∑ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞)
        if (this.currentStep < 5) {
          this.currentStep++;
        }
      } else {
        // –ï—Å–ª–∏ —Ç–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é (6 —à–∞–≥–æ–≤)
        if (this.currentStep < 6) {
          this.currentStep++;
        }
      }
    },

    prevStep() {
      // –í –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É 1
      if (this.currentStep > 1) {
        this.currentStep--;
      }
    },

    selectProgram(program) {
      this.selectedProgram = program;
      this.nextStep(); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É (–≤—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞)
    },

    selectAmount(amount) {
      this.selectedAmount = amount;
      this.nextStep(); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É (–≤—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞)
    },

    selectCustomAmount() {
      if (parseInt(this.customAmount) >= 1000) {
        this.selectedAmount = { label: `${this.customAmount} ‚ÇΩ`, value: parseInt(this.customAmount) };
        this.nextStep(); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É (–≤—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞)
      } else {
        alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ ‚Äî 1 000 ‚ÇΩ');
      }
    },

    async finishOrder() {
      try {
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
        const certificateData = {
          certificate_type: this.selectedCertType === 'program' ? 'certificate' : 'deposit',
          format: this.selectedFormat === 'printed' ? '–ü–µ—á–∞—Ç–Ω—ã–π' : '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π',
          recipient_name: this.recipientName,
          recipient_phone: this.recipientPhone,
          buyer_name: this.buyerName,
          buyer_phone: this.buyerPhone,
          program_id: this.selectedProgram ? this.selectedProgram.id : null,
          amount: this.selectedAmount ? this.selectedAmount.value * 100 : 0, // –≤ –∫–æ–ø–µ–π–∫–∞—Ö
        };

        // –í—ã–∑–æ–≤–µ–º –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏–∑ —Å—Ç–æ—Ä–∞
        const result = await this.createCertificate(certificateData);

        // –ó–∞–∫—Ä–æ–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        this.closeModal();

        // –°–æ—Ö—Ä–∞–Ω–∏–º –∫–æ–¥ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ –ø–æ–∫–∞–∂–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        this.certificateCode = result.code || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        this.showConfirmationModal = true;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      }
    },

    resetForm() {
      this.currentStep = 1;
      this.selectedCertType = null;
      this.selectedProgram = null;
      this.selectedAmount = null;
      this.customAmount = '';
      this.selectedFormat = null;
      this.recipientName = '';
      this.recipientPhone = '';
      // –ù–µ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è, –æ–Ω–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    },

    truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
  }
}
</script>