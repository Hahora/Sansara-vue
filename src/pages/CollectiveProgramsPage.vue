<template>
  <div class="p-4">
    <div class="flex items-center mb-4">
      <router-link to="/" class="btn-back mr-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        –ù–∞–∑–∞–¥
      </router-link>
      <h1 class="page-title text-xl">–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h1>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="isLoading" class="flex justify-center items-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#4e5d51]"></div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div v-else-if="error" class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700 mb-4">
      {{ error }}
    </div>

    <div v-else class="space-y-4">
      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö -->
      <div class="card">
        <h2 class="section-title">üë• <b>–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</b></h2>
        <p class="text-black text-sm mb-3">–¢–µ–ø–ª–æ, –∂–∏–≤–æ–π –ø–∞—Ä, –æ–±—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –µ–¥–∏–Ω–µ–Ω–∏–µ</p>

        <div class="bg-wood-50 rounded-lg p-3 mb-3">
          <p class="text-black"><b>–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:</b></p>
          <p class="text-black">–≠—Ç–æ –±–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–π, –≥–¥–µ –≤—ã –≤–º–µ—Å—Ç–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –æ–±—â–∏–µ —Ä–∏—Ç—É–∞–ª—ã –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏. –ü–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ —Ç—Ä–∞–¥–∏—Ü–∏–∏ —Ä—É—Å—Å–∫–æ–π –±–∞–Ω–∏ –≤ –∫—Ä—É–≥—É –±–ª–∏–∑–∫–∏—Ö –ª—é–¥–µ–π.</p>

          <p class="text-black mt-2"><b>–î–ª—è –∫–∞–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π –ø–æ–¥—Ö–æ–¥—è—Ç:</b></p>
          <ul class="text-black text-sm list-disc pl-5">
            <li>–î—Ä—É–∑—å—è –∏ —Å–µ–º—å–∏</li>
            <li>–†–∞–±–æ—á–∏–µ –∫–æ–ª–ª–µ–∫—Ç–∏–≤—ã</li>
            <li>–¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã</li>
            <li>–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</li>
            <li>–õ—é–±—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ—Ç 4 —á–µ–ª–æ–≤–µ–∫</li>
          </ul>

          <p class="text-black mt-2"><b>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:</b></p>
          <ul class="text-black text-sm list-disc pl-5">
            <li>üî• <b>¬´–ü–∞—Ä –Ω–∞ –≤–µ—Å—å –º–∏—Ä¬ª</b> ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø–∞—Ä–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏</li>
            <li>üêâ <b>¬´–ñ–∞—Ä –ì–æ—Ä—ã–Ω—ã—á¬ª</b> ‚Äî –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞–º–∏</li>
            <li>üåø <b>¬´–ë–∞–Ω–Ω—ã–π –∫—Ä—É–≥¬ª</b> ‚Äî –º—è–≥–∫–æ–µ –ø–∞—Ä–µ–Ω–∏–µ —Å —Ç—Ä–∞–≤–∞–º–∏ –∏ –∞—Ä–æ–º–∞—Ç–∞–º–∏</li>
          </ul>

          <p class="text-black mt-2"><b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b></p>
          <p class="text-black">–ñ–∏–≤–æ–π –ø–∞—Ä, –∞—Ä–æ–º–∞—Ç –≤–µ–Ω–∏–∫–æ–≤, –µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π, –æ—â—É—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ª–µ–≥–∫–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.</p>
        </div>
      </div>

      <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
      <div v-if="collectivePrograms.length > 0" class="card">
        <h2 class="section-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2>

        <div class="space-y-3">
          <div
            v-for="program in collectivePrograms"
            :key="program.id"
            class="bg-wood-50 rounded-lg p-3 border border-wood-200 cursor-pointer hover:bg-wood-100 transition-colors"
            @click="openProgramDetails(program)"
          >
            <div class="flex justify-between items-start">
              <div>
                <p class="text-black font-medium">{{ program.name }}</p>
                <p class="text-black text-sm">{{ truncateText(program.description, 80) }}</p>
              </div>
              <span class="text-black font-medium">{{ program.price ? program.price / 100 : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É' }} ‚ÇΩ</span>
            </div>
          </div>
        </div>
      </div>
      <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã (–µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ API) -->
      <div v-else class="card">
        <h2 class="section-title">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2>

        <div class="space-y-3">
          <div class="bg-wood-50 rounded-lg p-3">
            <p class="text-black font-medium">üî• ¬´–ü–∞—Ä –Ω–∞ –≤–µ—Å—å –º–∏—Ä¬ª</p>
            <p class="text-black text-sm">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø–∞—Ä–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏</p>
          </div>

          <div class="bg-wood-50 rounded-lg p-3">
            <p class="text-black font-medium">üêâ ¬´–ñ–∞—Ä –ì–æ—Ä—ã–Ω—ã—á¬ª</p>
            <p class="text-black text-sm">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞–º–∏</p>
          </div>

          <div class="bg-wood-50 rounded-lg p-3">
            <p class="text-black font-medium">üåø ¬´–ë–∞–Ω–Ω—ã–π –∫—Ä—É–≥¬ª</p>
            <p class="text-black text-sm">–ú—è–≥–∫–æ–µ –ø–∞—Ä–µ–Ω–∏–µ —Å —Ç—Ä–∞–≤–∞–º–∏ –∏ –∞—Ä–æ–º–∞—Ç–∞–º–∏</p>
          </div>
        </div>
      </div>

      <!-- –°—Å—ã–ª–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div class="space-y-3">
        <router-link to="/programs" class="text-black text-base font-medium underline cursor-pointer block text-center">
          üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        </router-link>

        <!-- –ò—â–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º -->
        <div v-if="collectiveProgram">
          <router-link
            :to="{
              name: 'BookingWithParams',
              params: {
                programId: collectiveProgram.id,
                programType: collectiveProgram.program_type,
                eventId: collectiveProgram.slug
              }
            }"
            class="btn-primary block text-center"
          >
            üìù –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
          </router-link>
        </div>
        <div v-else>
          <router-link
            :to="{ name: 'BookingWithParams', params: { programType: 'collective' }}"
            class="btn-primary block text-center opacity-70 cursor-not-allowed"
            disabled
          >
            üìù –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
          </router-link>
          <p class="text-red-500 text-xs mt-1 text-center">
            –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
          </p>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
    <ProgramDetailsModal
      :is-open="showProgramDetails"
      :program="selectedProgram"
      @close="closeProgramDetails"
    />
  </div>

</template>

<script>
import { mapState, mapGetters, mapActions } from 'pinia';
import { useAppStore } from '@/stores/appStore';
import ProgramDetailsModal from '@/components/ProgramDetailsModal.vue';

export default {
  name: 'CollectiveProgramsPage',
  components: {
    ProgramDetailsModal
  },
  data() {
    return {
      showProgramDetails: false,
      selectedProgram: {}
    };
  },
  computed: {
    ...mapState(useAppStore, ['isLoading', 'error', 'programs', 'user', 'programsLoaded']),
    ...mapGetters(useAppStore, ['getProgramsByType']),

    collectivePrograms() {
      return this.getProgramsByType('collective') || []; // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º lowercase, —Ç.–∫. —Å—Ç–æ—Ä –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç enum-–∑–Ω–∞—á–µ–Ω–∏—è
    },

    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º
    collectiveProgram() {
      if (!this.programs || this.programs.length === 0) return null;

      // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É —Å —Ç–∏–ø–æ–º 'collective'
      let program = this.programs.find(p =>
        p.program_type === 'collective'
      );

      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
      if (!program) {
        program = this.programs.find(p =>
          p.name.toLowerCase().includes('–∫–æ–ª–ª–µ–∫—Ç–∏–≤') ||
          p.name.toLowerCase().includes('–≥—Ä—É–ø–ø–æ–≤–æ–π') ||
          p.name.toLowerCase().includes('team') ||
          p.name.toLowerCase().includes('group')
        );
      }

      return program || null;
    }
  },
  async mounted() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (!this.programsLoaded && this.loadPrograms) {
      await this.loadPrograms();
    }
  },
  methods: {
    ...mapActions(useAppStore, ['loadPrograms']),

    truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    },

    openProgramDetails(program) {
      this.selectedProgram = program;
      this.showProgramDetails = true;
    },

    closeProgramDetails() {
      this.showProgramDetails = false;
      this.selectedProgram = {};
    }
  }
}
</script>
